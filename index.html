<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Shirley's AI Assistant in Speaking ‚Äî with Pronunciation Feedback (safe)</title>
  <style>
    :root{
      --primary-color:#4a6fa5;--secondary-color:#6b8cbc;--accent-color:#ff7e5f;
      --light-color:#f5f7fa;--dark-color:#2c3e50;--success-color:#2ecc71;
      --warning-color:#f39c12;--error-color:#e74c3c;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
    body{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:var(--dark-color);line-height:1.6;padding:20px;min-height:100vh;}
    .container{max-width:800px;margin:0 auto;background:#fff;border-radius:15px;box-shadow:0 20px 40px rgba(0,0,0,.1);padding:30px;position:relative;overflow:hidden;}
    .container::before{content:'';position:absolute;top:0;left:0;right:0;height:5px;background:linear-gradient(90deg,var(--primary-color),var(--accent-color));}
    h1,h2,h3{color:var(--primary-color);margin-bottom:20px;}
    h1{text-align:center;font-size:2.2em;background:linear-gradient(135deg,var(--primary-color),var(--accent-color));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:30px;}
    .form-group{margin-bottom:25px;}
    label{display:block;margin-bottom:8px;font-weight:600;color:var(--dark-color);}    
    input,textarea,select{width:100%;padding:15px;border:2px solid #e1e5e9;border-radius:10px;font-size:16px;transition:all .3s ease;background:#f8f9fa;}
    input:focus,textarea:focus,select:focus{outline:none;border-color:var(--primary-color);background:#fff;box-shadow:0 0 0 3px rgba(74,111,165,.1);}    
    textarea{min-height:120px;resize:vertical;}
    .btn{background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));color:#fff;border:none;padding:15px 30px;border-radius:10px;cursor:pointer;font-size:16px;font-weight:600;transition:all .3s ease;width:100%;margin-bottom:10px;position:relative;overflow:hidden;}
    .btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);transition:left .5s;}
    .btn:hover::before{left:100%;}
    .btn:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(0,0,0,.2);}    
    .btn:active{transform:translateY(0);}    
    .btn-accent{background:linear-gradient(135deg,var(--accent-color),#ff9a7f);}        
    .btn-success{background:linear-gradient(135deg,var(--success-color),#27ae60);}       
    .btn-error{background:linear-gradient(135deg,var(--error-color),#c0392b);}          
    .hidden{display:none!important;}
    .welcome-message{text-align:center;margin-bottom:30px;color:#666;font-size:1.1em;}
    .sentence-source{display:flex;gap:15px;margin-bottom:20px;}
    .sentence-source-btn{flex:1;padding:15px;text-align:center;border:2px solid #e1e5e9;border-radius:10px;background:#f8f9fa;cursor:pointer;transition:all .3s ease;}
    .sentence-source-btn:hover{background:#e9ecef;}
    .sentence-source-btn.active{background:var(--primary-color);color:#fff;border-color:var(--primary-color);}        
    .level-selection{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:15px;}
    .level-btn{padding:12px;text-align:center;border:2px solid #e1e5e9;border-radius:8px;background:#f8f9fa;cursor:pointer;transition:all .3s ease;}
    .level-btn:hover{background:#e9ecef;}
    .level-btn.active{background:var(--primary-color);color:#fff;border-color:var(--primary-color);}        
    .practice-item{background:#fff;border-radius:15px;padding:25px;margin-bottom:25px;border-left:5px solid var(--primary-color);box-shadow:0 5px 15px rgba(0,0,0,.08);}        
    .sentence-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
    .sentence-number{font-size:18px;font-weight:700;color:var(--primary-color);}        
    .sentence-container{display:flex;align-items:center;margin-bottom:20px;background:#f8f9fa;padding:20px;border-radius:10px;}
    .sentence-text{flex-grow:1;font-size:18px;font-weight:500;color:var(--dark-color);}        
    .audio-btn{background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));border:none;font-size:20px;cursor:pointer;color:#fff;margin-left:15px;padding:12px;border-radius:50%;min-width:50px;height:50px;display:flex;align-items:center;justify-content:center;transition:all .3s ease;}
    .audio-btn:hover{transform:scale(1.1);box-shadow:0 5px 15px rgba(0,0,0,.2);}        
    .recording-controls{display:flex;flex-direction:column;align-items:center;margin-bottom:20px;}
    .recording-btn{padding:18px 35px;border-radius:50px;font-weight:600;margin-bottom:20px;width:100%;max-width:250px;font-size:18px;}
    .recording-indicator{display:inline-block;width:15px;height:15px;background-color:var(--error-color);border-radius:50%;margin-right:10px;animation:pulse 1.5s infinite;}
    @keyframes pulse{0%{transform:scale(1);opacity:1;}50%{transform:scale(1.2);opacity:.7;}100%{transform:scale(1);opacity:1;}}
    .progress-bar{height:12px;background:#e9ecef;border-radius:10px;margin:25px 0;overflow:hidden;box-shadow:inset 0 2px 4px rgba(0,0,0,.1);}        
    .progress{height:100%;background:linear-gradient(90deg,var(--primary-color),var(--accent-color));width:0%;transition:width .5s ease;border-radius:10px;}
    .report-section{background:#fff;border-radius:15px;padding:30px;margin-top:30px;box-shadow:0 10px 30px rgba(0,0,0,.1);border:2px solid #e9ecef;}
    .report-header{text-align:center;margin-bottom:30px;padding-bottom:20px;border-bottom:3px solid var(--primary-color);}        
    .report-info-line{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;padding:15px;background:#f8f9fa;border-radius:8px;flex-wrap:wrap;gap:10px;}
    .report-info-item{display:flex;align-items:center;gap:5px;}
    .report-info-label{font-weight:600;color:var(--primary-color);}        
    .sentence-score-item{padding:15px;margin-bottom:10px;background:#f8f9fa;border-radius:8px;border-left:4px solid var(--primary-color);}        
    .navigation{display:flex;justify-content:space-between;margin-top:30px;gap:15px;}
    .navigation .btn{width:auto;flex:1;}
    .status-message{padding:15px;border-radius:10px;margin:15px 0;text-align:center;font-weight:500;}
    .status-error{background:linear-gradient(135deg,rgba(231,76,60,.1),rgba(192,57,43,.1));color:var(--error-color);border:2px solid var(--error-color);}        
    .status-info{background:linear-gradient(135deg,rgba(52,152,219,.1),rgba(41,128,185,.1));color:var(--primary-color);border:2px solid var(--primary-color);}        
    .print-only{display:none;}
    .no-print{}
    @media print{ body{background:#fff!important;padding:0;} .no-print{display:none!important;} .print-only{display:block!important;} .practice-item,.report-section{break-inside:avoid;} }
    .report-title{ color:#2c3e50!important;background:none!important; -webkit-text-fill-color:#2c3e50!important; -webkit-background-clip:initial!important;background-clip:initial!important; }
    @media print{ .report-title{ color:#000!important;-webkit-text-fill-color:#000!important;background:none!important; } }
    @media (max-width:768px){ body{padding:10px;} .container{padding:20px;border-radius:10px;} h1{font-size:1.8em;} .practice-item{padding:20px;} .sentence-container{flex-direction:column;align-items:flex-start;padding:15px;} .audio-btn{margin-left:0;margin-top:15px;align-self:center;} .report-info-line{flex-direction:column;align-items:flex-start;gap:8px;} .navigation{flex-direction:column;} .btn{padding:18px;} .sentence-source{flex-direction:column;} .level-selection{grid-template-columns:repeat(2,1fr);} }
    @media (max-width:480px){ body{padding:5px;} .container{padding:15px;} h1{font-size:1.5em;} .sentence-text{font-size:16px;} .recording-btn{padding:20px;font-size:16px;} .level-selection{grid-template-columns:1fr;} }
  </style>
</head>
<body>
  <div class="container">
    <div id="sentence-source-page">
      <h1>Shirley's AI Assistant in Speaking</h1>
      <div class="welcome-message">Please select your sentence source to start practicing.</div>
      <div class="form-group">
        <label>Sentence Source</label>
        <div class="sentence-source">
          <div class="sentence-source-btn active" data-source="manual">Enter Manually</div>
          <div class="sentence-source-btn" data-source="level">From Sentence Bank</div>
        </div>
        <div id="manual-input" class="sentence-input">
          <label for="sentences">Practice Sentences (one per line, maximum 10)</label>
          <textarea id="sentences" placeholder="Enter or paste sentences to practice, one per line"></textarea>
        </div>
        <div id="level-input" class="sentence-input hidden">
          <label>Select Difficulty Level</label>
          <div class="level-selection">
            <div class="level-btn" data-level="1">Level 1</div>
            <div class="level-btn" data-level="2">Level 2</div>
            <div class="level-btn" data-level="3">Level 3</div>
            <div class="level-btn" data-level="4">Level 4</div>
            <div class="level-btn" data-level="5">Level 5</div>
            <div class="level-btn" data-level="6">Level 6</div>
          </div>
          <button id="load-level-sentences" class="btn btn-accent" style="margin-top:15px;">Load 10 Random Sentences</button>
        </div>
      </div>
      <button id="start-practice" class="btn">Start Practice</button>
    </div>

    <div id="practice-page" class="hidden">
      <h1>English Pronunciation Practice</h1>
      <div class="progress-bar"><div id="progress" class="progress"></div></div>
      <div id="practice-container"></div>
      <div class="navigation">
        <button id="prev-sentence" class="btn">Previous</button>
        <button id="next-sentence" class="btn">Next</button>
      </div>
      <button id="finish-practice" class="btn btn-accent">Finish Practice</button>
    </div>

    <div id="report-modal" class="hidden">
      <div style="background:#fff;padding:24px;border-radius:12px;max-width:500px;margin:0 auto;">
        <h2 style="text-align:center;margin-bottom:20px;">Print Report</h2>
        <div class="form-group">
          <label for="report-class">Class</label>
          <input type="text" id="report-class-input" placeholder="e.g., 5A">
        </div>
        <div class="form-group">
          <label for="report-seat">Seat No.</label>
          <input type="text" id="report-seat-input" placeholder="e.g., 12">
        </div>
        <div class="form-group">
          <label for="report-name">Name</label>
          <input type="text" id="report-name-input" placeholder="e.g., Shirley">
        </div>
        <button id="generate-report" class="btn btn-accent">Generate Report</button>
      </div>
    </div>
  </div>

  <script>
    let sentences=[], currentSentenceIndex=0, mediaRecorder, audioChunks=[], isRecording=false,
        practicedSentences=[], sentenceSource='manual', selectedLevel=null, currentStream=null;

    const stripBracketTail = (s)=> s.replace(/\s*\[[^\]]*\]\s*$/, '');

    const sentenceSourcePage=document.getElementById('sentence-source-page');
    const practicePage=document.getElementById('practice-page');
    const reportModal=document.getElementById('report-modal');
    const startPracticeBtn=document.getElementById('start-practice');
    const finishPracticeBtn=document.getElementById('finish-practice');
    const prevSentenceBtn=document.getElementById('prev-sentence');
    const nextSentenceBtn=document.getElementById('next-sentence');
    const generateReportBtn=document.getElementById('generate-report');
    const practiceContainer=document.getElementById('practice-container');
    const progressBar=document.getElementById('progress');
    const manualInput=document.getElementById('manual-input');
    const levelInput=document.getElementById('level-input');
    const loadLevelSentencesBtn=document.getElementById('load-level-sentences');

    document.querySelectorAll('.sentence-source-btn').forEach(btn=>{
      btn.addEventListener('click',function(){
        document.querySelectorAll('.sentence-source-btn').forEach(b=>b.classList.remove('active'));
        this.classList.add('active');
        sentenceSource = this.getAttribute('data-source');
        if(sentenceSource==='manual'){ manualInput.classList.remove('hidden'); levelInput.classList.add('hidden'); }
        else{ manualInput.classList.add('hidden'); levelInput.classList.remove('hidden'); }
      });
    });

    document.querySelectorAll('.level-btn').forEach(btn=>{
      btn.addEventListener('click',function(){
        document.querySelectorAll('.level-btn').forEach(b=>b.classList.remove('active'));
        this.classList.add('active'); selectedLevel=this.getAttribute('data-level');
      });
    });

    async function loadLevelSentences(){
      if(!selectedLevel){ showStatusMessage('Please select a difficulty level first','error',levelInput); return; }
      try{
        showStatusMessage(`Loading sentences from Level ${selectedLevel}...`,'info',levelInput);
        const rows = await fetchLevelSentences(selectedLevel);
        if(rows.length===0){ showStatusMessage('No sentences found for this level','error',levelInput); return; }
        const shuffled=[...rows].sort(()=>0.5-Math.random());
        const chosen=shuffled.slice(0,10);
        const formatted = chosen.map((item,idx)=> `${item.sentence} [${idx+1}/10 - Level ${selectedLevel}, Sentence ${item.number}]`);
        document.getElementById('sentences').value = formatted.join('\n');
        showStatusMessage(`‚úÖ Loaded 10 sentences from Level ${selectedLevel}`,'info',levelInput);
      }catch(e){
        console.error(e);
        document.getElementById('sentences').value='';
        showStatusMessage(`‚ùå ${e.message}`,'error',levelInput);
      }
    }
    loadLevelSentencesBtn.addEventListener('click',loadLevelSentences);

    async function fetchLevelSentences(level){
      const resp = await fetch(`level${level}.csv`);
      if(!resp.ok) throw new Error(`Failed to load Level ${level}`);
      const text = await resp.text();
      const lines = text.trim().split('\n');
      return lines.map(l=>l.trim()).filter(Boolean).map((line,idx)=>{
        const firstComma=line.indexOf(',');
        if(firstComma===-1) return { number:`${idx+1}`, sentence:line };
        return { number: line.substring(0,firstComma).trim(), sentence: line.substring(firstComma+1).trim() };
      });
    }

    function showStatusMessage(message,type,container=document.body){
      const existing=container.querySelector('.status-message'); if(existing) existing.remove();
      const el=document.createElement('div'); el.className=`status-message status-${type}`; el.textContent=message;
      container.insertBefore(el,container.firstChild);
      setTimeout(()=>el.remove(), type==='error'?8000:5000);
    }

    startPracticeBtn.addEventListener('click', ()=>{
      let arr = document.getElementById('sentences').value.split('\n').map(s=>s.trim()).filter(Boolean);
      if(sentenceSource==='level' && arr.length===0){ showStatusMessage('‚ùå Please load sentences from Sentence Bank first','error'); return; }
      if(arr.length===0){ showStatusMessage('‚ùå Please enter at least one sentence','error'); return; }
      if(arr.length>10) arr = arr.slice(0,10);
      sentences=arr; practicedSentences=[...arr]; currentSentenceIndex=0;
      sentenceSourcePage.classList.add('hidden'); practicePage.classList.remove('hidden');
      showCurrentSentence(); updateProgress();
    });

    function showCurrentSentence(){
      practiceContainer.innerHTML='';
      const raw = sentences[currentSentenceIndex];
      const m = raw.match(/^[\s\S]+?\s*\[\s*(\d+)\s*\/\s*(\d+)\s*-\s*Level\s*(\d+)\s*,\s*Sentence\s*([^\]]+)\s*\]\s*$/i);
      const displaySentence = m ? raw.replace(/\s*\[[^\]]*\]\s*$/,'').trim() : stripBracketTail(raw).trim();
      const practiceNumber  = `${currentSentenceIndex+1}/${sentences.length}`;
      const levelNo         = m ? m[3] : null;
      const sentNo          = m ? (m[4]||'').trim() : null;
      const sourceLabel     = (levelNo && sentNo) ? `Level ${levelNo}Ôºõ${sentNo}` : '';

      practiceContainer.innerHTML = `
        <div class=\"practice-item\">\n          <div class=\"sentence-header\">\n            <div class=\"sentence-number\">Sentence ${practiceNumber}</div>\n            ${sourceLabel ? `<div class=\"sentence-source\" style=\"color:#666;font-size:14px;\">${sourceLabel}</div>` : ''}\n          </div>\n          <div class=\"sentence-container\">\n            <div class=\"sentence-text\">${displaySentence}</div>\n            <button class=\"audio-btn\" data-sentence=\"${displaySentence.replace(/\"/g,'&quot;')}\" title=\"Listen to original\">üîä</button>\n          </div>\n          <div class=\"recording-controls\">\n            <button id=\"record-btn\" class=\"btn recording-btn btn-success\">üé§ Start Recording</button>\n            <div id=\"recording-indicator\" class=\"hidden\"><span class=\"recording-indicator\"></span> üî¥ Recording...</div>\n            <div id=\"recording-error\" class=\"hidden status-error\" style=\"margin-top:10px;\">‚ùå Recording failed. Please check microphone permissions.</div>\n          </div>\n          <div id=\"playback-section\" class=\"hidden\">\n            <p>üéß Your recording:</p>\n            <audio id=\"playback-audio\" controls style=\"width:100%;margin:15px 0;\"></audio>\n          </div>\n          <div id=\"feedback-panel\" class=\"hidden\" style=\"margin-top:10px;\">\n            <div id=\"feedback-status\" class=\"status-message status-info\">Ready.</div>\n            <div id=\"feedback-result\" style=\"display:none;\">\n              <div style=\"padding:12px;border-radius:8px;background:#f8f9fa;margin-top:8px;\">\n                <div><strong>Total Score:</strong> <span id=\"fb-total\">-</span>/100</div>\n                <div>Accuracy: <span id=\"fb-acc\">-</span> | Fluency: <span id=\"fb-flu\">-</span> | Prosody: <span id=\"fb-pro\">-</span></div>\n                <div style=\"margin-top:6px;\">WPM: <span id=\"fb-wpm\">-</span> ¬∑ Pauses: <span id=\"fb-pause\">-</span> ¬∑ PitchVar: <span id=\"fb-pitch\">-</span></div>\n                <div style=\"margin-top:10px;\"><strong>Tips:</strong>\n                  <ul id=\"fb-tips\" style=\"margin-left:20px;\"></ul>\n                </div>\n                <div id=\"fb-note\" style=\"margin-top:6px;color:#a67c00;\"></div>\n              </div>\n            </div>\n          </div>\n        </div>`;

      document.querySelector('.audio-btn').addEventListener('click', function(){
        const utter = new SpeechSynthesisUtterance(this.getAttribute('data-sentence'));
        utter.lang='en-US'; utter.rate=0.9; speechSynthesis.speak(utter);
      });

      document.getElementById('record-btn').addEventListener('click', toggleRecording);

      // ‚Äî‚Äî Defensive mount for feedback panel ‚Äî‚Äî //
      let fbPanel = document.getElementById('feedback-panel');
      if (!fbPanel) {
        const container = document.querySelector('.practice-item');
        const div = document.createElement('div');
        div.id = 'feedback-panel';
        div.className = 'hidden';
        div.style.marginTop = '10px';
        div.innerHTML = `
          <div id=\"feedback-status\" class=\"status-message status-info\">Ready.</div>
          <div id=\"feedback-result\" style=\"display:none;\">
            <div style=\"padding:12px;border-radius:8px;background:#f8f9fa;margin-top:8px;\">
              <div><strong>Total Score:</strong> <span id=\"fb-total\">-</span>/100</div>
              <div>Accuracy: <span id=\"fb-acc\">-</span> | Fluency: <span id=\"fb-flu\">-</span> | Prosody: <span id=\"fb-pro\">-</span></div>
              <div style=\"margin-top:6px;\">WPM: <span id=\"fb-wpm\">-</span> ¬∑ Pauses: <span id=\"fb-pause\">-</span> ¬∑ PitchVar: <span id=\"fb-pitch\">-</span></div>
              <div style=\"margin-top:10px;\"><strong>Tips:</strong>
                <ul id=\"fb-tips\" style=\"margin-left:20px;\"></ul>
              </div>
              <div id=\"fb-note\" style=\"margin-top:6px;color:#a67c00;\"></div>
            </div>
          </div>`;
        container?.appendChild(div);
        fbPanel = div;
      }
      if (fbPanel) fbPanel.classList.remove('hidden');

      window.renderFeedbackStatus = function(msg){
        const s = document.getElementById('feedback-status');
        const r = document.getElementById('feedback-result');
        if (s) { s.textContent = msg; s.style.display = 'block'; }
        if (r) { r.style.display = 'none'; }
      }

      window.renderFeedbackResult = function(res){
        const s = document.getElementById('feedback-status');
        const r = document.getElementById('feedback-result');
        if (!r) { console.warn('feedback-result missing', res); return; }
        const setText = (id, value) => { const el = document.getElementById(id); if (el) el.textContent = value; };
        setText('fb-total',   res?.scores?.total   ?? '-');
        setText('fb-acc',     res?.scores?.accuracy?? '-');
        setText('fb-flu',     res?.scores?.fluency ?? '-');
        setText('fb-pro',     res?.scores?.prosody ?? '-');
        setText('fb-wpm',     res?.metrics?.wpm    ?? '-');
        setText('fb-pause',   res?.metrics?.pauseRatio ?? '-');
        setText('fb-pitch',   res?.metrics?.pitchVar   ?? '-');
        const tipsUl = document.getElementById('fb-tips');
        if (tipsUl) {
          tipsUl.innerHTML = '';
          (res?.tips || []).forEach(t=>{ const li=document.createElement('li'); li.textContent=t; tipsUl.appendChild(li); });
        }
        const note = document.getElementById('fb-note');
        if (note) note.textContent = (res && res.notes && res.notes[0]) ? res.notes[0] : '';
        if (s) s.style.display = 'none';
        r.style.display = 'block';
      }
    }

    document.getElementById('prev-sentence').addEventListener('click', ()=>{
      if(currentSentenceIndex>0){ currentSentenceIndex--; showCurrentSentence(); updateProgress(); }
    });
    document.getElementById('next-sentence').addEventListener('click', ()=>{
      if(currentSentenceIndex<sentences.length-1){ currentSentenceIndex++; showCurrentSentence(); updateProgress(); }
    });
    function updateProgress(){ const p=((currentSentenceIndex+1)/sentences.length)*100; progressBar.style.width=p+'%'; }

    async function toggleRecording(){ if(!isRecording) await startRecording(); else stopRecording(); }
    async function startRecording(){
      try{
        const stream = await navigator.mediaDevices.getUserMedia({audio:true});
        mediaRecorder = new MediaRecorder(stream); currentStream=stream; audioChunks=[];
        mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);
        mediaRecorder.onstop=()=>{
          const blob = new Blob(audioChunks,{type:'audio/webm'});
          const url = URL.createObjectURL(blob);
          document.getElementById('playback-audio').src=url;
          document.getElementById('playback-section').classList.remove('hidden');
          const displaySentence = document.querySelector('.audio-btn')?.getAttribute('data-sentence') || '';
          window.renderFeedbackStatus && window.renderFeedbackStatus('Analyzing pronunciation‚Ä¶');
          if(window.PronunciationFeedback){
            window.PronunciationFeedback.analyzePronunciation({ blob, targetText: displaySentence })
              .then(res => window.renderFeedbackResult ? window.renderFeedbackResult(res) : console.log(res))
              .catch(err => window.renderFeedbackStatus && window.renderFeedbackStatus('‚ùå Analysis failed: '+(err?.message||err)));
          }
        };
        mediaRecorder.start(); isRecording=true;
        const btn=document.getElementById('record-btn');
        btn.textContent='üõë Stop Recording'; btn.classList.remove('btn-success'); btn.classList.add('btn-error');
        document.getElementById('recording-indicator').classList.remove('hidden');
      }catch(err){ alert('Microphone access denied'); }
    }
    function stopRecording(){
      if(mediaRecorder && isRecording){
        mediaRecorder.stop(); isRecording=false;
        if(currentStream){ currentStream.getTracks().forEach(t=>t.stop()); currentStream=null; }
        const btn=document.getElementById('record-btn');
        btn.textContent='üé§ Record Again'; btn.classList.remove('btn-error'); btn.classList.add('btn-success');
        document.getElementById('recording-indicator').classList.add('hidden');
      }
    }

    finishPracticeBtn.addEventListener('click', ()=>{ reportModal.classList.remove('hidden'); });
    generateReportBtn.addEventListener('click', generateReport);

    function generateReport(){
      const className=document.getElementById('report-class-input').value.trim();
      const seatNo=document.getElementById('report-seat-input').value.trim();
      const name=document.getElementById('report-name-input').value.trim();
      if(!className||!seatNo||!name){ alert('Please fill in all fields'); return; }
      const reportDiv=document.createElement('div');
      reportDiv.className='container print-only'; reportDiv.style.display='block';
      const date=new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});
      const listHtml = practicedSentences.map((s,i)=>{
        const m = s.match(/^[\s\S]+?\s*\[\s*(\d+)\s*\/\s*(\d+)\s*-\s*Level\s*(\d+)\s*,\s*Sentence\s*([^\]]+)\s*\]\s*$/i);
        const main = m ? s.replace(/\s*\[[^\]]*\]\s*$/,'').trim() : stripBracketTail(s).trim();
        const source = m ? ` <span style=\"color:#666;font-size:0.95em;\">ÔºàLevel ${m[3]}Ôºõ${(m[4]||'').trim()}Ôºâ</span>` : '';
        return `<div class=\"sentence-score-item\"><div><strong>Sentence ${i+1}:</strong> ${main}${source}</div></div>`;
      }).join('');

      reportDiv.innerHTML=`
        <div class=\"report-section\">\n          <div class=\"report-header\" style=\"text-align:center;margin-bottom:25px;\">\n            <h1 class=\"report-title\" style=\"font-size:1.9em;margin-bottom:8px;font-weight:800;\">Speaking Practice Report with Shirley's AI in Speaking</h1>\n            <hr style=\"border:none;height:3px;background:linear-gradient(90deg,#4a6fa5,#ff7e5f);border-radius:2px;margin:15px auto;width:80%;\">\n          </div>\n          <div class=\"report-info-line\">\n            <div class=\"report-info-item\"><span class=\"report-info-label\">Class:</span> ${className}</div>\n            <div class=\"report-info-item\"><span class=\"report-info-label\">Seat No.:</span> ${seatNo}</div>\n            <div class=\"report-info-item\"><span class=\"report-info-label\">Name:</span> ${name}</div>\n            <div class=\"report-info-item\"><span class=\"report-info-label\">Date:</span> ${date}</div>\n          </div>\n          <div class=\"sentence-list\"><h3>Practice Sentences:</h3>${listHtml}</div>\n          <p style=\"text-align:center;font-size:1.3em;margin-top:30px;color:#4a6fa5;\">You are fantastic! Keep practicing, as practice makes perfect! üòä</p>\n        </div>`;

      const appContainer=document.querySelector('body > .container');
      if(appContainer) appContainer.classList.add('no-print');
      document.body.appendChild(reportDiv);
      reportModal.classList.add('hidden');
      window.print();
      if(appContainer) appContainer.classList.remove('no-print');
      document.body.removeChild(reportDiv);
    }
  </script>

  <script>
  (function (global) {
    const supportsSR = !!(window.SpeechRecognition || window.webkitSpeechRecognition);
    const norm = s => s.toLowerCase().replace(/[^\w\s']/g, ' ').replace(/\s+/g, ' ').trim();
    function tokenize(s){ return norm(s).split(' ').filter(Boolean); }
    function lev(a, b){ const m=a.length, n=b.length; const dp=Array.from({length:m+1},()=>Array(n+1).fill(0)); for(let i=0;i<=m;i++) dp[i][0]=i; for(let j=0;j<=n;j++) dp[0][j]=j; for(let i=1;i<=m;i++){ for(let j=1;j<=n;j++){ const cost = a[i-1]===b[j-1]?0:1; dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost); } } return dp[m][n]; }
    function WER(refTokens, hypTokens){ if(refTokens.length===0) return hypTokens.length===0?0:1; return lev(refTokens, hypTokens) / refTokens.length; }
    function similarity(refTokens, hypTokens){ const maxLen = Math.max(refTokens.length, hypTokens.length, 1); return 1 - (lev(refTokens, hypTokens)/maxLen); }

    async function analyzeAudioFeatures(blob){ const arrayBuf = await blob.arrayBuffer(); const ac = new (window.AudioContext || window.webkitAudioContext)(); const audioBuf = await ac.decodeAudioData(arrayBuf); const ch = audioBuf.getChannelData(0); const sampleRate = audioBuf.sampleRate; const duration = audioBuf.duration; const frameSize = Math.floor(sampleRate * 0.03); const hop = Math.floor(frameSize * 0.5); let energies = []; for(let i=0;i+frameSize<ch.length;i+=hop){ let sum=0; for(let j=0;j<frameSize;j++){ const v=ch[i+j]; sum+=v*v; } energies.push(sum / frameSize); } const energyMean = energies.reduce((a,b)=>a+b,0)/Math.max(energies.length,1); const pauseThresh = energyMean*0.15; const pauses = energies.filter(e=>e<pauseThresh).length; const pauseRatio = energies.length? (pauses/energies.length):0; function estimatePitchHz(frame){ let maxLag = Math.floor(sampleRate/80); let minLag = Math.floor(sampleRate/500); let bestLag = 0, best = -Infinity; for(let lag=minLag; lag<=maxLag; lag++){ let sum=0; for(let i=0; i+lag<frame.length; i++){ sum += frame[i]*frame[i+lag]; } if(sum>best){ best=sum; bestLag=lag; } } return bestLag? (sampleRate/bestLag):0; } let pitches = []; for(let i=0;i+frameSize<ch.length;i+=hop){ const frame = ch.slice(i, i+frameSize); const pitch = estimatePitchHz(frame); if(pitch>60 && pitch<400 && energies[Math.floor(i/hop)]>pauseThresh) pitches.push(pitch); } const pitchMean = pitches.length? pitches.reduce((a,b)=>a+b,0)/pitches.length : 0; const pitchVar = pitches.length? (pitches.reduce((a,b)=>a+(b-pitchMean)*(b-pitchMean),0)/pitches.length) : 0; ac.close?.(); return { duration, pauseRatio, energyMean, pitchVar, sampleRate }; }

    function wordsPerMinute(spokenWordsCount, durationSec){ const minutes = Math.max(durationSec/60, 1e-3); return spokenWordsCount / minutes; }

    function speechToText(){ return new Promise((resolve)=>{ if(!supportsSR){ return resolve({ ok:false, text:'', message:'SpeechRecognition not supported' }); } try{ const SR = window.SpeechRecognition || window.webkitSpeechRecognition; const rec = new SR(); rec.lang = 'en-US'; rec.interimResults = false; rec.maxAlternatives = 1; let finalized = false; rec.onresult = (ev)=>{ finalized = true; const text = ev.results[0][0].transcript || ''; resolve({ ok:true, text, confidence: ev.results[0][0].confidence ?? 0.6 }); }; rec.onerror = ()=>{ if(!finalized) resolve({ ok:false, text:'', message:'SR error' }); }; rec.onend = ()=>{ if(!finalized) resolve({ ok:false, text:'', message:'SR ended without result' }); }; rec.start(); }catch{ resolve({ ok:false, text:'', message:'SR init failed' }); } }); }

    async function analyzePronunciation({ blob, targetText, hypTextWhenSRUnavailable='' }){
      const refTokens = tokenize(targetText);
      const feats = await analyzeAudioFeatures(blob);
      let sr = await speechToText();
      let hypText = sr.ok ? sr.text : hypTextWhenSRUnavailable;
      const hypTokens = tokenize(hypText);
      const sim = (refTokens.length && hypTokens.length) ? similarity(refTokens, hypTokens) : 0;
      const wer = (refTokens.length && hypTokens.length) ? WER(refTokens, hypTokens) : 1;
      let accuracyScore = Math.max(0, Math.min(100, Math.round(sim*100)));
      const wpm = wordsPerMinute(hypTokens.length || refTokens.length, feats.duration);
      const wpmScore = (()=>{ if(wpm>=110 && wpm<=180) return 100; if(wpm<60) return 40*(wpm/60); if(wpm>220) return Math.max(20, 100-(wpm-180)); if(wpm<110) return 60 + (wpm-60)*(40/50); return 100 - (wpm-180)*(100/40); })();
      const pauseScore = Math.max(0, 100 - (feats.pauseRatio*200));
      const fluencyScore = Math.round(0.7*wpmScore + 0.3*pauseScore);
      const pv = feats.pitchVar;
      const prosodyScore = (()=> { if(pv===0) return 50; if(pv<150) return 60 + (pv/150)*20; if(pv<1200) return 80 + (Math.min(pv,1200)-150)*(20/1050); return Math.max(65, 100 - (pv-1200)/8); })();
      let A=0.6, F=0.2, P=0.2; if(!sr.ok){ A=0.3; F=0.35; P=0.35; if(accuracyScore===0) accuracyScore = 40; }
      const total = Math.round(A*accuracyScore + F*fluencyScore + P*prosodyScore);
      const tips = []; if(wer>0.25 || accuracyScore<75) tips.push('Â§öÁ∑¥ÁøíÂñÆÂ≠óÈÄ£ËÆÄËàáÈáçÈü≥‰ΩçÁΩÆÔºõÈÄêÂè•ÊØîÂ∞çÈóúÈçµÂ≠óÈÅøÂÖçÊºèÂ≠ó„ÄÇ'); if(wpm<100) tips.push('Ë™ûÈÄüÁï•ÊÖ¢ÔºåÂèØÂòóË©¶Ë∑üËÆÄÂéüÈü≥ÔºåÊèêÂçáÁØÄÂ•èËàáÈÄ£Ë≤´Â∫¶„ÄÇ'); if(wpm>190) tips.push('Ë™ûÈÄüÂÅèÂø´ÔºåÊ≥®ÊÑèÊñ∑Âè•ËàáÊ∏ÖÊô∞Â∫¶„ÄÇ'); if(feats.pauseRatio>0.25) tips.push('ÂÅúÈ†ìËºÉÂ§öÔºåÂª∫Ë≠∞ÂÖàÂàÜÊÆµÁ∑¥ÁøíÔºåÂÜçÈÄêÊ≠•Âêà‰ΩµÊï¥Âè•„ÄÇ'); if(prosodyScore<80) tips.push('Ë™ûË™øËºÉÂñÆË™øÔºåÂòóË©¶Âú®ÈáçËÆÄË©ûÊèêÈ´òÈü≥È´òÊàñÊôÇÈï∑„ÄÇ'); if(tips.length===0) tips.push('ÁôºÈü≥Êï¥È´îË°®ÁèæËâØÂ•ΩÔºå‰øùÊåÅÁ∑¥ÁøíÔºÅ');
      return { ok:true, srSupported: sr.ok, transcripts: { hypText, targetText }, metrics: { similarity: +sim.toFixed(3), wer: +wer.toFixed(3), wpm: Math.round(wpm), pauseRatio: +feats.pauseRatio.toFixed(3), pitchVar: Math.round(feats.pitchVar) }, scores: { accuracy: accuracyScore, fluency: fluencyScore, prosody: prosodyScore, total }, notes: sr.ok ? [] : ['Êú™ÂïüÁî®Êàñ‰∏çÊîØÊè¥ÁÄèË¶ΩÂô®Ë™ûÈü≥Ëæ®Ë≠òÔºöÂ∑≤‰ª•Èü≥Ë®äÁâπÂæµ‰º∞ÂàÜÔºåÊ∫ñÁ¢∫Â∫¶Ê¨äÈáç‰∏ãË™ø„ÄÇ'], tips };
    }

    global.PronunciationFeedback = { analyzePronunciation };
  })(window);
  </script>
</body>
</html>
