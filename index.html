<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Shirley's AI Assistant in Speaking ‚Äî Simple Matching</title>
  <style>
    :root{ --primary-color:#4a6fa5;--secondary-color:#6b8cbc;--accent-color:#ff7e5f; --light-color:#f5f7fa;--dark-color:#2c3e50;--success-color:#2ecc71; --warning-color:#f39c12;--error-color:#e74c3c; }
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
    body{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:var(--dark-color);line-height:1.6;padding:20px;min-height:100vh;}
    .container{max-width:860px;margin:0 auto;background:#fff;border-radius:15px;box-shadow:0 20px 40px rgba(0,0,0,.1);padding:30px;position:relative;overflow:hidden;}
    .container::before{content:'';position:absolute;top:0;left:0;right:0;height:5px;background:linear-gradient(90deg,var(--primary-color),var(--accent-color));}
    h1,h2,h3{color:var(--primary-color);margin-bottom:20px;}
    h1{text-align:center;font-size:2.2em;background:linear-gradient(135deg,var(--primary-color),var(--accent-color));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:30px;}
    .form-group{margin-bottom:25px;} label{display:block;margin-bottom:8px;font-weight:600;color:var(--dark-color);}    
    input,textarea,select{width:100%;padding:15px;border:2px solid #e1e5e9;border-radius:10px;font-size:16px;transition:all .3s ease;background:#f8f9fa;}
    input:focus,textarea:focus,select:focus{outline:none;border-color:var(--primary-color);background:#fff;box-shadow:0 0 0 3px rgba(74,111,165,.1);}    
    textarea{min-height:120px;resize:vertical;}
    .btn{background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));color:#fff;border:none;padding:15px 30px;border-radius:10px;cursor:pointer;font-size:16px;font-weight:600;transition:all .3s ease;width:100%;margin-bottom:10px;position:relative;overflow:hidden;}
    .btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);transition:left .5s;}
    .btn:hover::before{left:100%;}
    .btn:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(0,0,0,.2);}    
    .btn:active{transform:translateY(0);}    
    .btn-accent{background:linear-gradient(135deg,var(--accent-color),#ff9a7f);}        
    .btn-success{background:linear-gradient(135deg,var(--success-color),#27ae60);}       
    .btn-error{background:linear-gradient(135deg,var(--error-color),#c0392b);}          
    .hidden{display:none!important;}
    .welcome-message{text-align:center;margin-bottom:30px;color:#666;font-size:1.1em;}
    .sentence-source{display:flex;gap:15px;margin-bottom:20px;}
    .sentence-source-btn{flex:1;padding:15px;text-align:center;border:2px solid #e1e5e9;border-radius:10px;background:#f8f9fa;cursor:pointer;transition:all .3s ease;}
    .sentence-source-btn:hover{background:#e9ecef;}
    .sentence-source-btn.active{background:var(--primary-color);color:#fff;border-color:var(--primary-color);}        
    .level-selection{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:15px;}
    .level-btn{padding:12px;text-align:center;border:2px solid #e1e5e9;border-radius:8px;background:#f8f9fa;cursor:pointer;transition:all .3s ease;}
    .level-btn:hover{background:#e9ecef;}
    .level-btn.active{background:var(--primary-color);color:#fff;border-color:var(--primary-color);}        
    .practice-item{background:#fff;border-radius:15px;padding:25px;margin-bottom:25px;border-left:5px solid var(--primary-color);box-shadow:0 5px 15px rgba(0,0,0,.08);}        
    .sentence-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
    .sentence-number{font-size:18px;font-weight:700;color:var(--primary-color);}        
    .sentence-container{display:flex;align-items:center;margin-bottom:20px;background:#f8f9fa;padding:20px;border-radius:10px;}
    .sentence-text{flex-grow:1;font-size:18px;font-weight:500;color:var(--dark-color);}        
    .audio-btn{background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));border:none;font-size:20px;cursor:pointer;color:#fff;margin-left:15px;padding:12px;border-radius:50%;min-width:50px;height:50px;display:flex;align-items:center;justify-content:center;transition:all .3s ease;}
    .audio-btn:hover{transform:scale(1.1);box-shadow:0 5px 15px rgba(0,0,0,.2);}        
    .recording-controls{display:flex;flex-direction:column;align-items:center;margin-bottom:20px;}
    .recording-btn{padding:18px 35px;border-radius:50px;font-weight:600;margin-bottom:20px;width:100%;max-width:250px;font-size:18px;}
    .recording-indicator{display:inline-block;width:15px;height:15px;background-color:var(--error-color);border-radius:50%;margin-right:10px;animation:pulse 1.5s infinite;}
    @keyframes pulse{0%{transform:scale(1);opacity:1;}50%{transform:scale(1.2);opacity:.7;}100%{transform:scale(1);opacity:1;}}
    .progress-bar{height:12px;background:#e9ecef;border-radius:10px;margin:25px 0;overflow:hidden;box-shadow:inset 0 2px 4px rgba(0,0,0,.1);}        
    .progress{height:100%;background:linear-gradient(90deg,var(--primary-color),var(--accent-color));width:0%;transition:width .5s ease;border-radius:10px;}
    .report-section{background:#fff;border-radius:15px;padding:30px;margin-top:30px;box-shadow:0 10px 30px rgba(0,0,0,.1);border:2px solid #e9ecef;}
    .report-header{text-align:center;margin-bottom:30px;padding-bottom:20px;border-bottom:3px solid var(--primary-color);}        
    .report-info-line{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;padding:15px;background:#f8f9fa;border-radius:8px;flex-wrap:wrap;gap:10px;}
    .report-info-item{display:flex;align-items:center;gap:5px;}
    .report-info-label{font-weight:600;color:var(--primary-color);}        
    .sentence-score-item{padding:15px;margin-bottom:10px;background:#f8f9fa;border-radius:8px;border-left:4px solid var(--primary-color);}        
    .navigation{display:flex;justify-content:space-between;margin-top:30px;gap:15px;}
    .navigation .btn{width:auto;flex:1;}
    .status-message{padding:15px;border-radius:10px;margin:15px 0;text-align:center;font-weight:500;}
    .status-error{background:linear-gradient(135deg,rgba(231,76,60,.1),rgba(192,57,43,.1));color:var(--error-color);border:2px solid var(--error-color);}        
    .status-info{background:linear-gradient(135deg,rgba(52,152,219,.1),rgba(41,128,185,.1));color:var(--primary-color);border:2px solid var(--primary-color);}        
    .print-only{display:none;} .no-print{}
    @media print{ body{background:#fff!important;padding:0;} .no-print{display:none!important;} .print-only{display:block!important;} .practice-item,.report-section{break-inside:avoid;} }
    .report-title{ color:#2c3e50!important; background:none!important; -webkit-text-fill-color:#2c3e50!important; -webkit-background-clip:initial!important; background-clip:initial!important; }
    @media print{ .report-title{ color:#000!important; -webkit-text-fill-color:#000!important; background:none!important; } }
    @media (max-width:768px){ body{padding:10px;} .container{padding:20px;border-radius:10px;} h1{font-size:1.8em;} .practice-item{padding:20px;} .sentence-container{flex-direction:column;align-items:flex-start;padding:15px;} .audio-btn{margin-left:0;margin-top:15px;align-self:center;} .report-info-line{flex-direction:column;align-items:flex-start;gap:8px;} .navigation{flex-direction:column;} .btn{padding:18px;} .sentence-source{flex-direction:column;} .level-selection{grid-template-columns:repeat(2,1fr);} }
    @media (max-width:480px){ body{padding:5px;} .container{padding:15px;} h1{font-size:1.5em;} .sentence-text{font-size:16px;} .recording-btn{padding:20px;font-size:16px;} .level-selection{grid-template-columns:1fr;} }
  </style>
</head>
<body>
  <div class="container">
    <!-- Source Select Page -->
    <div id="sentence-source-page">
      <h1>Shirley's AI Assistant in Speaking</h1>
      <div class="welcome-message">Please select your sentence source to start practicing.</div>
      <div class="form-group">
        <label>Sentence Source</label>
        <div class="sentence-source">
          <div class="sentence-source-btn active" data-source="manual">Enter Manually</div>
          <div class="sentence-source-btn" data-source="level">From Sentence Bank</div>
        </div>
        <div id="manual-input" class="sentence-input">
          <label for="sentences">Practice Sentences (one per line, maximum 10)</label>
          <textarea id="sentences" placeholder="Enter or paste sentences to practice, one per line"></textarea>
        </div>
        <div id="level-input" class="sentence-input hidden">
          <label>Select Difficulty Level</label>
          <div class="level-selection">
            <div class="level-btn" data-level="1">Level 1</div>
            <div class="level-btn" data-level="2">Level 2</div>
            <div class="level-btn" data-level="3">Level 3</div>
            <div class="level-btn" data-level="4">Level 4</div>
            <div class="level-btn" data-level="5">Level 5</div>
            <div class="level-btn" data-level="6">Level 6</div>
          </div>
          <button id="load-level-sentences" class="btn btn-accent" style="margin-top:15px;">Load 10 Random Sentences</button>
        </div>
      </div>
      <button id="start-practice" class="btn">Start Practice</button>
    </div>
    <!-- Practice Page -->
    <div id="practice-page" class="hidden">
      <h1>English Pronunciation Practice</h1>
      <div class="progress-bar"><div id="progress" class="progress"></div></div>
      <div id="practice-container"></div>
      <div class="navigation">
        <button id="prev-sentence" class="btn">Previous</button>
        <button id="next-sentence" class="btn">Next</button>
      </div>
      <button id="finish-practice" class="btn btn-accent">Finish Practice</button>
    </div>
    <!-- Report Modal -->
    <div id="report-modal" class="hidden">
      <div style="background:#fff;padding:24px;border-radius:12px;max-width:640px;margin:0 auto;">
        <h2 style="text-align:center;margin-bottom:20px;">Print Report</h2>
        <div class="form-group">
          <label for="report-class">Class</label>
          <input type="text" id="report-class-input" placeholder="e.g., 5A">
        </div>
        <div class="form-group">
          <label for="report-seat">Seat No.</label>
          <input type="text" id="report-seat-input" placeholder="e.g., 12">
        </div>
        <div class="form-group">
          <label for="report-name">Name</label>
          <input type="text" id="report-name-input" placeholder="e.g., Shirley">
        </div>
        <button id="generate-report" class="btn btn-accent">Generate Report</button>
      </div>
    </div>
  </div>
  <script>
    // Global state
    let sentences=[], currentIndex=0, mediaRecorder, audioChunks=[], isRecording=false,
        practicedSentences=[], sentenceSource='manual', selectedLevel=null, currentStream=null;
    const feedbackResults = [];
    const stripBracketTail = (s)=> s.replace(/\s*\[[^\]]*\]\s*$/, '');
    // DOM refs
    const sentenceSourcePage=document.getElementById('sentence-source-page');
    const practicePage=document.getElementById('practice-page');
    const reportModal=document.getElementById('report-modal');
    const startPracticeBtn=document.getElementById('start-practice');
    const finishPracticeBtn=document.getElementById('finish-practice');
    const prevBtn=document.getElementById('prev-sentence');
    const nextBtn=document.getElementById('next-sentence');
    const generateReportBtn=document.getElementById('generate-report');
    const practiceContainer=document.getElementById('practice-container');
    const progressBar=document.getElementById('progress');
    const manualInput=document.getElementById('manual-input');
    const levelInput=document.getElementById('level-input');
    const loadLevelSentencesBtn=document.getElementById('load-level-sentences');
    // UI helpers
    function showStatusMessage(message,type,container=document.body){ const existing=container.querySelector('.status-message'); if(existing) existing.remove(); const el=document.createElement('div'); el.className=`status-message status-${type}`; el.textContent=message; container.insertBefore(el,container.firstChild); setTimeout(()=>el.remove(), 5000); }
    document.querySelectorAll('.sentence-source-btn').forEach(btn=>{ btn.addEventListener('click',function(){ document.querySelectorAll('.sentence-source-btn').forEach(b=>b.classList.remove('active')); this.classList.add('active'); sentenceSource = this.getAttribute('data-source'); if(sentenceSource==='manual'){ manualInput.classList.remove('hidden'); levelInput.classList.add('hidden'); } else { manualInput.classList.add('hidden'); levelInput.classList.remove('hidden'); } }); });
    document.querySelectorAll('.level-btn').forEach(btn=>{ btn.addEventListener('click',function(){ document.querySelectorAll('.level-btn').forEach(b=>b.classList.remove('active')); this.classList.add('active'); selectedLevel=this.getAttribute('data-level'); }); });
    async function fetchLevelSentences(level){ const resp = await fetch(`level${level}.csv`); if(!resp.ok) throw new Error(`Failed to load Level ${level}`); const text = await resp.text(); const lines = text.trim().split('\n'); return lines.map(l=>l.trim()).filter(Boolean).map((line,idx)=>{ const firstComma=line.indexOf(','); if(firstComma===-1) return { number:`${idx+1}`, sentence:line }; return { number: line.substring(0,firstComma).trim(), sentence: line.substring(firstComma+1).trim() }; }); }
    async function loadLevelSentences(){ if(!selectedLevel){ showStatusMessage('Please select a difficulty level first','error',levelInput); return; } try{ showStatusMessage(`Loading sentences from Level ${selectedLevel}...`,'info',levelInput); const rows = await fetchLevelSentences(selectedLevel); if(rows.length===0){ showStatusMessage('No sentences found for this level','error',levelInput); return; } const shuffled=[...rows].sort(()=>0.5-Math.random()); const chosen=shuffled.slice(0,10); const formatted = chosen.map((item,idx)=> `${item.sentence} [${idx+1}/10 - Level ${selectedLevel}, Sentence ${item.number}]`); document.getElementById('sentences').value = formatted.join('\n'); showStatusMessage(`‚úÖ Loaded 10 sentences from Level ${selectedLevel}`,'info',levelInput); }catch(e){ console.error(e); document.getElementById('sentences').value=''; showStatusMessage(`‚ùå ${e.message}`,'error',levelInput); } }
    loadLevelSentencesBtn.addEventListener('click',loadLevelSentences);
    startPracticeBtn.addEventListener('click', ()=>{ let arr = document.getElementById('sentences').value.split('\n').map(s=>s.trim()).filter(Boolean); if(sentenceSource==='level' && arr.length===0){ showStatusMessage('‚ùå Please load sentences from Sentence Bank first','error'); return; } if(arr.length===0){ showStatusMessage('‚ùå Please enter at least one sentence','error'); return; } if(arr.length>10) arr = arr.slice(0,10); sentences=arr; practicedSentences=[...arr]; currentIndex=0; feedbackResults.length = sentences.length; sentenceSourcePage.classList.add('hidden'); practicePage.classList.remove('hidden'); showCurrent(); updateProgress(); });
    function showCurrent(){ practiceContainer.innerHTML=''; const raw = sentences[currentIndex]; const m = raw.match(/^[\s\S]+?\s*\[\s*(\d+)\s*\/\s*(\d+)\s*-\s*Level\s*(\d+)\s*,\s*Sentence\s*([^\]]+)\s*\]\s*$/i); const displaySentence = m ? raw.replace(/\s*\[[^\]]*\]\s*$/,'').trim() : stripBracketTail(raw).trim(); const practiceNumber  = m ? `${m[1]}/${m[2]}` : `${currentIndex+1}/${sentences.length}`; const levelNo = m ? m[3] : null; const sentNo = m ? m[4].trim() : null; const sourceLabel = (levelNo && sentNo) ? `Level ${levelNo}Ôºõ${sentNo}` : '';
      practiceContainer.innerHTML = `
        <div class="practice-item">
          <div class="sentence-header">
            <div class="sentence-number">Sentence ${practiceNumber}</div>
            ${sourceLabel ? `<div class="sentence-source" style="color:#666;font-size:14px;">${sourceLabel}</div>` : ''}
          </div>
          <div class="sentence-container">
            <div class="sentence-text">${displaySentence}</div>
            <button class="audio-btn" data-sentence="${displaySentence.replace(/"/g,'&quot;')}" title="Listen to original">üîä</button>
          </div>
          <div class="recording-controls">
            <button id="record-btn" class="btn recording-btn btn-success">üé§ Start Recording</button>
            <div id="recording-indicator" class="hidden"><span class="recording-indicator"></span> üî¥ Recording...</div>
            <div id="recording-error" class="hidden status-error" style="margin-top:10px;">‚ùå Recording failed. Please check microphone permissions.</div>
          </div>
          <div id="playback-section" class="hidden">
            <p>üéß Your recording:</p>
            <audio id="playback-audio" controls style="width:100%;margin:15px 0;"></audio>
          </div>
          <div id="feedback-panel" class="hidden" style="margin-top:10px;">
            <div id="feedback-status" class="status-message status-info">Ready.</div>
            <div id="feedback-result" style="display:none;">
              <div style="padding:12px;border-radius:8px;background:#f8f9fa;margin-top:8px;">
                <div><strong>Total Score:</strong> <span id="fb-total">-</span>/100</div>
                <div>Accuracy: <span id="fb-acc">-</span> | Fluency: <span id="fb-flu">-</span> | Prosody: <span id="fb-pro">-</span></div>
                <div style="margin-top:6px;">WPM: <span id="fb-wpm">-</span> ¬∑ Pauses: <span id="fb-pause">-</span> ¬∑ PitchVar: <span id="fb-pitch">-</span></div>
                <div style="margin-top:6px;">Transcript: <span id="fb-hyp">-</span></div>
                <div style="margin-top:2px;">Target: <span id="fb-ref">-</span></div>
                <div style="margin-top:10px;"><strong>Tips:</strong>
                  <ul id="fb-tips" style="margin-left:20px;"></ul>
                </div>
              </div>
            </div>
          </div>
        </div>`;
      document.querySelector('.audio-btn').addEventListener('click', function(){ const utter = new SpeechSynthesisUtterance(this.getAttribute('data-sentence')); utter.lang='en-US'; utter.rate=0.9; speechSynthesis.speak(utter); });
      document.getElementById('record-btn').addEventListener('click', toggleRecording);
      const fbPanel = document.getElementById('feedback-panel'); fbPanel.classList.remove('hidden');
      window.renderFeedbackStatus = function(msg){ const s = document.getElementById('feedback-status'); const r = document.getElementById('feedback-result'); s.textContent = msg; s.style.display = 'block'; r.style.display = 'none'; }
      window.renderFeedbackResult = function(res){ const s = document.getElementById('feedback-status'); const r = document.getElementById('feedback-result'); document.getElementById('fb-total').textContent = res.scores.total; document.getElementById('fb-acc').textContent   = res.scores.accuracy; document.getElementById('fb-flu').textContent   = res.scores.fluency; document.getElementById('fb-pro').textContent   = res.scores.prosody; document.getElementById('fb-wpm').textContent   = res.metrics.wpm; document.getElementById('fb-pause').textContent = res.metrics.pauseRatio; document.getElementById('fb-pitch').textContent = res.metrics.pitchVar; const tipsUl = document.getElementById('fb-tips'); tipsUl.innerHTML = ''; (res.tips||[]).forEach(t=>{ const li=document.createElement('li'); li.textContent=t; tipsUl.appendChild(li); }); document.getElementById('fb-hyp').textContent = res.transcripts?.hypText || ''; document.getElementById('fb-ref').textContent = res.transcripts?.targetText || ''; s.style.display = 'none'; r.style.display = 'block'; feedbackResults[currentIndex]=res; }
    }
    prevBtn.addEventListener('click', ()=>{ if(currentIndex>0){ currentIndex--; showCurrent(); updateProgress(); } });
    nextBtn.addEventListener('click', ()=>{ if(currentIndex<sentences.length-1){ currentIndex++; showCurrent(); updateProgress(); } });
    function updateProgress(){ const p=((currentIndex+1)/sentences.length)*100; progressBar.style.width=p+'%'; }
    async function toggleRecording(){ if(!isRecording) await startRecording(); else stopRecording(); }
    async function startRecording(){ try{ const stream = await navigator.mediaDevices.getUserMedia({audio:true}); mediaRecorder = new MediaRecorder(stream); currentStream=stream; audioChunks=[]; mediaRecorder.ondataavailable=e=>audioChunks.push(e.data); mediaRecorder.onstop=async ()=>{ const rawBlob = new Blob(audioChunks,{type:'audio/webm'}); const cleanBlob = await (window.PronunciationFeedback?.trimSilence(rawBlob).catch(()=>rawBlob) || rawBlob); const url = URL.createObjectURL(cleanBlob); document.getElementById('playback-audio').src=url; document.getElementById('playback-section').classList.remove('hidden'); const displaySentence = document.querySelector('.audio-btn')?.getAttribute('data-sentence') || ''; if(window.renderFeedbackStatus){ window.renderFeedbackStatus('Analyzing pronunciation‚Ä¶'); } if(window.PronunciationFeedback){ window.PronunciationFeedback.analyzePronunciation({ blob: cleanBlob, targetText: displaySentence }) .then(res => { window.renderFeedbackResult ? window.renderFeedbackResult(res) : console.log(res); }) .catch(err => window.renderFeedbackStatus && window.renderFeedbackStatus('‚ùå Analysis failed: '+(err?.message||err))); } }; mediaRecorder.start(); isRecording=true; const btn=document.getElementById('record-btn'); btn.textContent='üõë Stop Recording'; btn.classList.remove('btn-success'); btn.classList.add('btn-error'); document.getElementById('recording-indicator').classList.remove('hidden'); }catch(err){ alert('Microphone access denied'); } }
    function stopRecording(){ if(mediaRecorder && isRecording){ mediaRecorder.stop(); isRecording=false; if(currentStream){ currentStream.getTracks().forEach(t=>t.stop()); currentStream=null; } const btn=document.getElementById('record-btn'); btn.textContent='üé§ Record Again'; btn.classList.remove('btn-error'); btn.classList.add('btn-success'); document.getElementById('recording-indicator').classList.add('hidden'); } }
    finishPracticeBtn.addEventListener('click', ()=>{ reportModal.classList.remove('hidden'); });
    generateReportBtn.addEventListener('click', generateReport);
    function safeNum(x, digits=2){ if(x==null || isNaN(x)) return '-'; const f=parseFloat(x); return isFinite(f)? f.toFixed(digits) : '-'; }
    function avg(arr){ const v=arr.filter(n=>typeof n==='number' && isFinite(n)); if(!v.length) return null; return v.reduce((a,b)=>a+b,0)/v.length; }
    function pickEncouragement(score){ if(score==null) return 'Keep going‚Äîyour persistence will pay off!'; if(score>=90) return 'Outstanding! Your pronunciation is clear and expressive‚Äîkeep shining!'; if(score>=80) return 'Great job! Your speaking is fluent and confident‚Äîstay consistent!'; if(score>=70) return 'Nice work! A bit more practice on stress and rhythm will bring you to the next level.'; if(score>=60) return 'Good effort! Focus on accuracy and pacing‚Äîyou are on the right track.'; return 'Every try counts! Read along with the model audio and practice shorter chunks‚Äîyou‚Äôll get there!'; }
    function generateReport(){
      const className=document.getElementById('report-class-input').value.trim();
      const seatNo=document.getElementById('report-seat-input').value.trim();
      const name=document.getElementById('report-name-input').value.trim();
      if(!className||!seatNo||!name){ alert('Please fill in all fields'); return; }
      const valid = feedbackResults.filter(r=>r);
      const totals = {
        total: avg(valid.map(r=>r.scores?.total)),
        acc:   avg(valid.map(r=>r.scores?.accuracy)),
        flu:   avg(valid.map(r=>r.scores?.fluency)),
        pro:   avg(valid.map(r=>r.scores?.prosody)),
        wpm:   avg(valid.map(r=>r.metrics?.wpm)),
        pause: avg(valid.map(r=>r.metrics?.pauseRatio)),
        pitch: avg(valid.map(r=>r.metrics?.pitchVar)),
      };
      const encouragement = pickEncouragement(totals.total);
      const reportDiv=document.createElement('div');
      reportDiv.className='container print-only'; reportDiv.style.display='block';
      const date=new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});
      const listHtml = practicedSentences.map((s,i)=>{
        const m = s.match(/^[\s\S]+?\s*\[\s*(\d+)\s*\/\s*(\d+)\s*-\s*Level\s*(\d+)\s*,\s*Sentence\s*([^\]]+)\s*\]\s*$/i);
        const main = m ? s.replace(/\s*\[[^\]]*\]\s*$/,'').trim() : stripBracketTail(s).trim();
        const source = m ? ` <span style="color:#666;font-size:0.95em;">ÔºàLevel ${m[3]}Ôºõ${(m[4]||'').trim()}Ôºâ</span>` : '';
        const r = feedbackResults[i];
        const lineScore = ` ‚Äî <strong>${r.scores.total}</strong>/100 (A:${r.scores.accuracy} F:${r.scores.fluency} P:${r.scores.prosody})`;
        const lineMeta  = ` | WPM ${r.metrics.wpm}, Pauses ${safeNum(r.metrics.pauseRatio,2)}`;
        return `
          <div class="sentence-score-item">
            <div><strong>Sentence ${i+1}:</strong> ${main}${source}${lineScore}${lineMeta}</div>
          </div>`;
      }).join('');
      const tipsAll = [];
      valid.forEach(r=> (r.tips||[]).forEach(t=> tipsAll.push(t)) );
      const topTips = Array.from(new Set(tipsAll)).slice(0,3).map(t=>`<li>${t}</li>`).join('');
      reportDiv.innerHTML=`
        <div class="report-section">
          <div class="report-header" style="text-align:center;margin-bottom:25px;">
            <h1 class="report-title" style="font-size:1.9em;margin-bottom:8px;font-weight:800;">Speaking Practice Report</h1>
            <hr style="border:none;height:3px;background:linear-gradient(90deg,#4a6fa5,#ff7e5f);border-radius:2px;margin:15px auto;width:80%;">
          </div>
          <div class="report-info-line">
            <div class="report-info-item"><span class="report-info-label">Class:</span> ${className}</div>
            <div class="report-info-item"><span class="report-info-label">Seat No.:</span> ${seatNo}</div>
            <div class="report-info-item"><span class="report-info-label">Name:</span> ${name}</div>
            <div class="report-info-item"><span class="report-info-label">Date:</span> ${date}</div>
          </div>
          <div class="report-section" style="margin-top:10px;">
            <h3>Session Summary (Simple Matching)</h3>
            <ul style="margin-left:20px;">
              <li>Sentences practiced: <strong>${sentences.length}</strong></li>
              <li>Average Score: <strong>${totals.total==null?'-':Math.round(totals.total)}</strong>/100 (Acc ${safeNum(totals.acc)}, Flu ${safeNum(totals.flu)}, Pro ${safeNum(totals.pro)})</li>
              <li>Avg WPM: <strong>${totals.wpm==null?'-':Math.round(totals.wpm)}</strong> ¬∑ Avg Pauses: <strong>${safeNum(totals.pause,2)}</strong> ¬∑ Avg PitchVar: <strong>${totals.pitch==null?'-':Math.round(totals.pitch)}</strong></li>
            </ul>
            ${topTips?`<div style="margin-top:8px;"><strong>Focus Tips:</strong><ul style="margin-left:20px;">${topTips}</ul></div>`:''}
            <div style="margin-top:10px;padding:12px;background:#f8fff5;border:1px solid #cdeccd;border-radius:8px;">
              <strong>Encouragement:</strong>
              <div>${encouragement}</div>
            </div>
          </div>
          <div class="sentence-list" style="margin-top:18px;">
            <h3>Per-Sentence Scores</h3>
            ${listHtml}
          </div>
        </div>`;
      const appContainer=document.querySelector('body > .container');
      if(appContainer) appContainer.classList.add('no-print');
      document.body.appendChild(reportDiv);
      reportModal.classList.add('hidden');
      window.print();
      if(appContainer) appContainer.classList.remove('no-print');
      document.body.removeChild(reportDiv);
    }
  </script>
  <!-- === Simplified pronunciation analysis (no gating) === -->
  <script>
  (function (global) {
    const supportsSR = !!(window.SpeechRecognition || window.webkitSpeechRecognition);
    const norm = s => s.toLowerCase().replace(/[^\w\s']/g, ' ').replace(/\s+/g, ' ').trim();
    function tokenize(s){ return norm(s).split(' ').filter(Boolean); }
    const FILLERS = new Set(['um','uh','erm','hmm','like','you','know','i','mean','ah','uhh']);
    const EQUIV = new Map([
      ["i'm","i am"],["you're","you are"],["we're","we are"],["they're","they are"],["he's","he is"],["she's","she is"],["it's","it is"],["that's","that is"],["what's","what is"],["there's","there is"],["won't","will not"],["can't","can not"],["don't","do not"],["doesn't","does not"],["didn't","did not"],["isn't","is not"],["aren't","are not"],["wasn't","was not"],["weren't","were not"],["gonna","going to"],["wanna","want to"],["gotta","got to"],["kinda","kind of"],["sorta","sort of"],["lemme","let me"]
    ]);
    function expandEquivalents(tokens){
      const out=[];
      for(const t of tokens){
        const m=EQUIV.get(t);
        if(m){ out.push(...m.split(' ')); } else out.push(t);
      }
      return out;
    }
    function dropFillers(tokens){ return tokens.filter(w=>!FILLERS.has(w)); }
    function lev(a,b){
      const m=a.length,n=b.length;
      const dp=Array.from({length:m+1},()=>Array(n+1).fill(0));
      for(let i=0;i<=m;i++) dp[i][0]=i;
      for(let j=0;j<=n;j++) dp[0][j]=j;
      for(let i=1;i<=m;i++){
        for(let j=1;j<=n;j++){
          const cost=a[i-1]===b[j-1]?0:1;
          dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
        }
      }
      return dp[m][n];
    }
    function WER(refTokens,hypTokens){
      if(refTokens.length===0) return hypTokens.length===0?0:1;
      return lev(refTokens,hypTokens)/refTokens.length;
    }
    function similarity(refTokens,hypTokens){
      const maxLen=Math.max(refTokens.length,hypTokens.length,1);
      return 1-(lev(refTokens,hypTokens)/maxLen);
    }
    async function decodeToPCM(blob){
      const ac=new (window.AudioContext||window.webkitAudioContext)();
      const buf=await ac.decodeAudioData(await blob.arrayBuffer());
      const pcm=buf.getChannelData(0);
      const sr=buf.sampleRate;
      ac.close?.();
      return { pcm, sampleRate: sr };
    }
    function pcmFloatToWav(samples,sampleRate){
      const buffer=new ArrayBuffer(44+samples.length*2);
      const view=new DataView(buffer);
      const w=(o,s)=>{ for(let i=0;i<s.length;i++) view.setUint8(o+i,s.charCodeAt(i)); };
      w(0,'RIFF');
      view.setUint32(4,36+samples.length*2,true);
      w(8,'WAVE');
      w(12,'fmt ');
      view.setUint32(16,16,true);
      view.setUint16(20,1,true);
      view.setUint16(22,1,true);
      view.setUint32(24,sampleRate,true);
      view.setUint32(28,sampleRate*2,true);
      view.setUint16(32,2,true);
      view.setUint16(34,16,true);
      w(36,'data');
      view.setUint32(40,samples.length*2,true);
      let o=44;
      for(let i=0;i<samples.length;i++){
        let s=Math.max(-1,Math.min(1,samples[i]));
        view.setInt16(o,s<0?s*0x8000:s*0x7FFF,true);
        o+=2;
      }
      return new Blob([new Uint8Array(buffer)],{type:'audio/wav'});
    }
    async function trimSilence(blob){
      const { pcm, sampleRate }=await decodeToPCM(blob);
      const frame=512,hop=256;
      let energies=[];
      for(let i=0;i+frame<pcm.length;i+=hop){
        let e=0;
        for(let j=0;j<frame;j++){
          const v=pcm[i+j];
          e+=v*v;
        }
        energies.push(e/frame);
      }
      if(!energies.length) return pcmFloatToWav(pcm,sampleRate);
      const sorted=[...energies].sort((a,b)=>a-b);
      const thr=sorted[Math.floor(sorted.length*0.15)]||0;
      const cons=6;
      let start=0,end=pcm.length-1,run=0;
      for(let i=0;i<energies.length;i++){
        run=energies[i]>thr?run+1:0;
        if(run>=cons){ start=(i-cons+1)*hop; break; }
      }
      run=0;
      for(let i=energies.length-1;i>=0;i--){
        run=energies[i]>thr?run+1:0;
        if(run>=cons){
          end=Math.min(pcm.length-1,(i+1)*hop);
          break;
        }
      }
      if(end<=start){
        start=0; end=pcm.length-1;
      }
      const cut=pcm.slice(start,end);
      return pcmFloatToWav(cut,sampleRate);
    }
    async function analyzeAudioFeatures(blob){
      const { pcm, sampleRate } = await decodeToPCM(blob);
      const duration = Math.max(0.001, pcm.length / sampleRate);
      const frameSize = Math.floor(sampleRate * 0.03), hop = Math.floor(frameSize * 0.5);
      let energies=[];
      for(let i=0;i+frameSize<pcm.length;i+=hop){
        let s=0;
        for(let j=0;j<frameSize;j++){
          const v=pcm[i+j];
          s+=v*v;
        }
        energies.push(s/frameSize);
      }
      if(energies.length===0) return { duration, pauseRatio:1, energyMean:0, pitchVar:0, sampleRate };
      const sorted=[...energies].sort((a,b)=>a-b);
      const pauseThresh = sorted[Math.floor(sorted.length*0.15)];
      const pauses = energies.filter(e=>e<pauseThresh).length;
      const pauseRatio = energies.length? (pauses/energies.length):1;
      function estimatePitchHz(frame){
        let maxLag=Math.floor(sampleRate/80), minLag=Math.floor(sampleRate/500);
        let bestLag=0,best=-Infinity;
        for(let lag=minLag; lag<=maxLag; lag++){
          let sum=0;
          for(let i=0;i+lag<frame.length;i++){
            sum+=frame[i]*frame[i+lag];
          }
          if(sum>best){
            best=sum;
            bestLag=lag;
          }
        }
        return bestLag? (sampleRate/bestLag):0;
      }
      let pitches=[];
      for(let i=0;i+frameSize<pcm.length;i+=hop){
        const frame = pcm.slice(i, i+frameSize);
        let e=0;
        for(let j=0;j<frame.length;j++){
          const v=frame[j];
          e+=v*v;
        }
        const pitch = estimatePitchHz(frame);
        if(pitch>60 && pitch<400 && e/frame.length>pauseThresh) pitches.push(pitch);
      }
      const mean = pitches.length? pitches.reduce((a,b)=>a+b,0)/pitches.length : 0;
      let pitchVar = pitches.length? (pitches.reduce((a,b)=>a+(b-mean)*(b-mean),0)/pitches.length) : 0;
      pitchVar = Math.min(pitchVar, 2000);
      return { duration, pauseRatio, energyMean: sorted[Math.floor(sorted.length*0.5)]||0, pitchVar, sampleRate };
    }
    function wordsPerMinute(spokenWordsCount, durationSec){
      const minutes=Math.max(durationSec/60,1e-3);
      return spokenWordsCount/minutes;
    }
    function speechToText(){
      return new Promise((resolve)=>{
        if(!supportsSR){
          return resolve({ ok:false, text:'', message:'SpeechRecognition not supported' });
        }
        try{
          const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
          const rec = new SR();
          rec.lang='en-US';
          rec.interimResults=false;
          rec.maxAlternatives=1;
          let finalized=false;
          rec.onresult=(ev)=>{
            finalized=true;
            const text = ev.results[0][0].transcript || '';
            resolve({ ok:true, text, confidence: ev.results[0][0].confidence ?? 0.5 });
          };
          rec.onerror=()=>{
            if(!finalized) resolve({ ok:false, text:'', message:'SR error' });
          };
          rec.onend=()=>{
            if(!finalized) resolve({ ok:false, text:'', message:'SR ended without result' });
          };
          rec.start();
        }catch{
          resolve({ ok:false, text:'', message:'SR init failed' });
        }
      });
    }
    // ‚úÖ Ê†∏ÂøÉÔºöÁÑ° gating ÁöÑ analyzePronunciation
    async function analyzePronunciation({ blob, targetText, hypTextWhenSRUnavailable='' }){
      const sr = await speechToText();
      const srOk = !!sr.ok;
      const hypText = srOk ? sr.text : hypTextWhenSRUnavailable;

      const refTokens0 = tokenize(targetText);
      const hypTokens0 = tokenize(hypText);
      const refTokens = dropFillers(expandEquivalents(refTokens0));
      const hypTokens = dropFillers(expandEquivalents(hypTokens0));

      const sim = (refTokens.length || hypTokens.length) ? similarity(refTokens, hypTokens) : 0;
      const wer = refTokens.length ? WER(refTokens, hypTokens) : (hypTokens.length > 0 ? 1 : 0);

      const feats = await analyzeAudioFeatures(blob);
      const wpm = wordsPerMinute(Math.max(hypTokens.length, 1), feats.duration);
      const wpmScore = (() => {
        if (wpm >= 110 && wpm <= 180) return 100;
        if (wpm < 60) return 40 * (wpm / 60);
        if (wpm > 220) return Math.max(20, 100 - (wpm - 180));
        if (wpm < 110) return 60 + (wpm - 60) * (40 / 50);
        return 100 - (wpm - 180) * (100 / 40);
      })();
      const pauseScore = Math.max(0, 100 - (feats.pauseRatio * 200));
      const fluencyScore = Math.round(0.7 * wpmScore + 0.3 * pauseScore);
      const pv = feats.pitchVar;
      const prosodyScore = (() => {
        if (pv === 0) return 50;
        if (pv < 150) return 60 + (pv / 150) * 20;
        if (pv < 1200) return 80 + (Math.min(pv, 1200) - 150) * (20 / 1050);
        return Math.max(65, 100 - (pv - 1200) / 8);
      })();

      let accuracyScore = Math.max(0, Math.min(100, Math.round(sim * 100)));
      if (!srOk && hypTextWhenSRUnavailable === '') {
        accuracyScore = 0;
      }

      const total = Math.round(0.6 * accuracyScore + 0.2 * fluencyScore + 0.2 * prosodyScore);

      const tips = [];
      if (wer > 0.25 || accuracyScore < 75) tips.push('Â§öÁ∑¥ÁøíÂñÆÂ≠óÈÄ£ËÆÄËàáÈáçÈü≥‰ΩçÁΩÆÔºõÈÄêÂè•ÊØîÂ∞çÈóúÈçµÂ≠óÈÅøÂÖçÊºèÂ≠ó„ÄÇ');
      if (wpm < 100) tips.push('Ë™ûÈÄüÁï•ÊÖ¢ÔºåÂèØÂòóË©¶Ë∑üËÆÄÂéüÈü≥ÔºåÊèêÂçáÁØÄÂ•èËàáÈÄ£Ë≤´Â∫¶„ÄÇ');
      if (wpm > 190) tips.push('Ë™ûÈÄüÂÅèÂø´ÔºåÊ≥®ÊÑèÊñ∑Âè•ËàáÊ∏ÖÊô∞Â∫¶„ÄÇ');
      if (feats.pauseRatio > 0.25) tips.push('ÂÅúÈ†ìËºÉÂ§öÔºåÂª∫Ë≠∞ÂÖàÂàÜÊÆµÁ∑¥ÁøíÔºåÂÜçÈÄêÊ≠•Âêà‰ΩµÊï¥Âè•„ÄÇ');
      if (prosodyScore < 80) tips.push('Ë™ûË™øËºÉÂñÆË™øÔºåÂòóË©¶Âú®ÈáçËÆÄË©ûÊèêÈ´òÈü≥È´òÊàñÊôÇÈï∑„ÄÇ');
      if (tips.length === 0) tips.push('ÁôºÈü≥Êï¥È´îË°®ÁèæËâØÂ•ΩÔºå‰øùÊåÅÁ∑¥ÁøíÔºÅ');

      return {
        ok: true,
        srSupported: srOk,
        transcripts: { hypText: hypText, targetText: targetText },
        metrics: {
          similarity: +sim.toFixed(3),
          wer: +wer.toFixed(3),
          wpm: Math.round(wpm),
          pauseRatio: +feats.pauseRatio.toFixed(3),
          pitchVar: Math.round(pv)
        },
        scores: {
          accuracy: accuracyScore,
          fluency: fluencyScore,
          prosody: prosodyScore,
          total: total
        },
        notes: [],
        tips: tips
      };
    }
    global.PronunciationFeedback = { analyzePronunciation, trimSilence };
  })(window);
  </script>
</body>
</html>
